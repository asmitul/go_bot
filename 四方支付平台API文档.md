# API 接口文档

- **基础地址**：`https://www.example.com/index.php?s=/Index/Api/{action}`
- **调用方式**：HTTP `POST`（`Content-Type: application/x-www-form-urlencoded`）
- **编码**：UTF-8
- **返回格式**：JSON

```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

`code = 0` 表示成功；非 0 为失败，错误原因见 `message`。

---

## 1. 鉴权方式

所有接口都需要携带以下公共参数，并进行签名校验：

| 参数          | 必填 | 说明                                                                   |
|---------------|------|------------------------------------------------------------------------|
| `merchant_id` | ✓    | 商户号（fx_user.userid）                                               |
| `timestamp`   | ✓    | Unix 时间戳（支持 10/13 位），允许 ±300 秒误差                         |
| `access_key`  | 可选 | 全局访问密钥，若匹配则签名使用 master key（推荐调试时启用）            |
| `sign`        | ✓    | 签名字符串                                                             |

### 签名算法

1. 收集所有请求参数（包括业务参数），去除 `sign`。
2. 按键名字典序排序。
3. 过滤空值 / `null` 参数；如为数组需 `json_encode`（`JSON_UNESCAPED_UNICODE`）。
4. `key=value` 形式拼接，使用 `&` 连接。
5. 结尾追加 `key={密钥}`，密钥规则：
   - 若提供 `access_key` 且与服务器配置的 master key 相同，则使用 master key；
   - 否则使用商户私钥 `miyao`。
6. 对整个字符串做 `md5`，并转大写即为 `sign`。

---

## 2. 接口总览

| 功能                  | 路径                            |
|-----------------------|---------------------------------|
| 查询账户余额          | `/balance`                      |
| 查询费率              | `/rates`                        |
| 订单列表              | `/orders`                       |
| 经营概览              | `/stats`                        |
| 订单详情              | `/orderdetail`                  |
| 手动补单              | `/manualcompleteorder`          |
| 手动撤单              | `/manualcancelorder`            |
| 回调日志              | `/notifylogs`                   |
| 按日汇总              | `/summarybyday`                 |
| 按日×通道汇总         | `/summarybydaychannel`          |
| 资金流水              | `/moneylogs`                    |
| 提现列表              | `/withdrawlist`                 |
| 提现详情              | `/withdrawdetail`               |
| 通道状态              | `/channelstatus`                |
| 费用报表              | `/feestatement`                 |
| 风险概览              | `/riskstats`                    |
| 手工调账记录          | `/manualadjustments`            |
| **模拟下单（新增）**  | `/createorder`                  |

以下接口均默认需要公共参数（`merchant_id`、`timestamp`、`access_key`、`sign`），仅列出额外的业务参数。

---

## 3. 余额查询 `/balance`

**说明**：查询账户余额、待提现金额等。

**返回字段**：

| 字段               | 说明           |
|--------------------|----------------|
| `merchant_id`      | 商户号         |
| `balance`          | 可用余额       |
| `pending_withdraw` | 待提现金额     |
| `currency`         | 币种（固定 CNY）|
| `updated_at`       | 更新时间       |

---

## 4. 费率查询 `/rates`

**说明**：获取商户开通的通道及费率设置。

**返回字段**：

`items` 数组，每项含：

| 字段               | 说明                                 |
|--------------------|--------------------------------------|
| `channel_code`     | 通道代码                             |
| `channel_name`     | 通道名称                             |
| `status`           | `enabled` / `disabled`               |
| `merchant_switch`  | 商户开关                             |
| `system_switch`    | 系统开关                             |
| `rate` / `rate_display` | 费率数值及展示形式             |
| `user_defined_rate`| 是否为自定义费率                     |

---

## 5. 订单列表 `/orders`

**业务参数**（均可选）：

| 参数                  | 说明                                            |
|-----------------------|-------------------------------------------------|
| `status`              | 0 未支付，1 成功，2 扣量                       |
| `merchant_order_no`   | 商户订单号                                     |
| `platform_order_no`   | 平台订单号                                     |
| `channel_code`        | 通道代码                                       |
| `start_time` ~ `end_time` | 创建时间区间                            |
| `pay_start` ~ `pay_end`   | 支付时间区间                            |
| `min_amount` / `max_amount` | 金额区间                             |
| `page` / `page_size`  | 分页（默认 1/20，`page_size ≤ 100`）         |

**返回字段**：

`items` 数组：含订单金额、支付状态、通知状态、通道信息、时间戳、商品信息等。  
`summary`：总金额、商户实收、代理收益汇总。

---

## 6. 经营概览 `/stats`

**说明**：返回今日、昨日、历史、待支付等核心指标。

**返回字段**：

| 字段       | 说明                                 |
|------------|--------------------------------------|
| `today`    | 今日订单数/金额/实收/代理收益         |
| `yesterday`| 昨日指标                             |
| `total`    | 历史累计                             |
| `pending`  | 待支付订单数及金额                   |

---

## 7. 订单详情 `/orderdetail`

**参数**（二选一）：
| 参数                | 说明                  |
|---------------------|-----------------------|
| `merchant_order_no` | 商户订单号            |
| `platform_order_no` | 平台订单号            |
| `with_notify_logs`  | 1/true 时返回回调日志 |

**返回**：
- `order` 基础信息 + `extended` 扩展字段（订单 ID、渠道费、扣量状态等）
- `notify_logs`（可选）

### 7.1 手动补单 `/manualcompleteorder`

**说明**：将未支付/扣量订单标记为成功，效果等同后台“手动补单”。

**业务参数**：

| 参数                | 必填 | 说明                                         |
|---------------------|------|----------------------------------------------|
| `merchant_order_no` | 否   | 商户订单号                                   |
| `platform_order_no` | 否   | 平台订单号                                   |
| `amount`            | 否   | 金额校验（单位元，传入时需与订单金额一致）   |

`merchant_order_no` 与 `platform_order_no` 至少提供一个。

**返回**：

- `order`：补单后的订单数据（同订单列表里的字段）。
- 若订单已成功，会直接返回当前状态。

> 注意：仅状态为未支付/扣量的订单可补单，操作会触发平台内部的资金结算逻辑。

### 7.2 手动撤单 `/manualcancelorder`

**说明**：撤销未支付 / 扣量订单，效果与后台“手动退单”一致。

**业务参数**：

| 参数                | 必填 | 说明                                       |
|---------------------|------|--------------------------------------------|
| `merchant_order_no` | 否   | 商户订单号                                |
| `platform_order_no` | 否   | 平台订单号                                |
| `amount`            | 否   | 金额校验（单位元，传入时需与订单金额一致）|

二者至少提供一个。

**返回**：补单后的订单数据（字段同 `/orders`）。若订单已成功会返回错误提示。

---

### 7.3 模拟下单 `/createorder`

**说明**：内部调用真实下单流程，快速生成支付链接。

**业务参数**：

| 参数             | 必填 | 说明                                                                 |
|------------------|------|------------------------------------------------------------------------|
| `order_no`       | 否   | 商户订单号（未传则自动生成）                                          |
| `amount`         | ✓    | 金额（单位元，保留两位小数）                                          |
| `channel_code`   | 否   | 通道代码（未传自动选用首个可用通道）                                  |
| `notify_url`     | 否   | 异步通知地址，默认 `https://当前域名/Test/notifyUrl`                  |
| `return_url`     | 否   | 同步回调地址，默认 `https://当前域名/Test/backUrl`                    |
| `description`    | 否   | 商品名称，默认“商品支付”                                              |
| `attach`         | 否   | 附加信息                                                               |
| `client_ip`      | 否   | 客户端 IP，默认获取调用方 IP                                          |
| `order_style`    | 否   | 订单类型：0=普通，1=充值，2=保证金，3=测试，4=商户二维码              |
| `scan_style`     | 否   | `1`/`cashier` 返回收银台链接，其余值默认返回原始链接                  |
| `notify_style`   | 否   | 1=表单，2/`json`=JSON                                                  |
| `bank_code`      | 否   | 银行编码（用于银行类通道）                                            |
| `payment_method` | 否   | 自定义支付方式                                                        |
| `sub_userid`     | 否   | 子商户号                                                              |
| `sign_string`    | 否   | 签名分隔符，默认 `|`                                                  |

**返回字段**：
- `merchant_order_no`：最终订单号
- `payment_url`：支付链接（若返回字符串）
- `payment`：上游原始字段（若返回数组，如二维码地址）
- `order_id`、`order_md5`、`platform_order_no`、`status`

> 注意：接口会真实写入订单，请确保金额、回调地址等信息正确；建议测试时使用较小金额。

---

## 8. 回调日志 `/notifylogs`

**参数**：
| 参数                | 说明         |
|---------------------|--------------|
| `merchant_order_no` | 商户订单号   |
| `platform_order_no` | 平台订单号   |
| `page` / `page_size`| 分页参数     |

**返回**：每条记录包含回调 URL、请求报文、响应内容、日志时间等。

---

## 9. 按日汇总 `/summarybyday`

**参数**：
| 参数               | 说明        |
|--------------------|-------------|
| `start_time`/`end_time` | 日期区间 |
| `channel_code`     | 限定通道    |

**返回**：按日期聚合的订单笔数、总金额、商户实收、代理收益。

### 9.1 按日×通道汇总 `/summarybydaychannel`

**参数**：
| 参数               | 说明                                   |
|--------------------|----------------------------------------|
| `start_time`/`end_time` | 日期区间                          |
| `channel_codes`    | 指定通道（数组或逗号分隔字符串）      |

**返回**：按日期和通道拆分的统计数据。

---

## 10. 资金流水 `/moneylogs`

**参数**：
| 参数         | 说明                                   |
|--------------|----------------------------------------|
| `style`      | 0=调整 1=充值 2=提现 3=分佣            |
| `start_time`/`end_time` | 时间区间                    |
| `page`/`page_size` | 分页（默认 1/20，最大 200）     |

**返回**：每条记录含变动金额、余额、描述、关联订单等。

---

## 11. 提现列表 `/withdrawlist`

**参数**：
| 参数         | 说明                                   |
|--------------|----------------------------------------|
| `status`     | 0申请 1已支付 2冻结 3取消              |
| `start_time`/`end_time` | 时间区间                    |
| `page`/`page_size` | 分页                             |

---

## 12. 提现详情 `/withdrawdetail`

**参数**：
| 参数         | 说明                                   |
|--------------|----------------------------------------|
| `withdraw_no`| 提现订单号（推荐）                     |
| `order_no`   | 提现表主键 ID                          |

**返回**：提现基础信息、回调日志、上游代付记录。

---

## 13. 通道状态 `/channelstatus`

**说明**：查询商户通道开关、限额、费率等。

**返回字段**：`channel_code`、`system_enabled`、`merchant_enabled`、`rate`、`min_amount`、`max_amount`、`daily_quota`、`daily_used`、`last_used_at` 等。

---

## 14. 费用报表 `/feestatement`

**参数**：
| 参数         | 说明                                   |
|--------------|----------------------------------------|
| `start_time`/`end_time` | 时间区间，默认近 30 天        |

**返回**：订单数、交易总额、商户实收、平台收入、平台手续费等。

---

## 15. 风险概览 `/riskstats`

**参数**：
| 参数          | 说明                          |
|---------------|-------------------------------|
| `high_amount` | 高额订单阈值（默认 1000 元） |

**返回**：超过 30 分钟未支付订单数、高额订单数、通知失败数、扣量订单数等。

---

## 16. 手工调账 `/manualadjustments`

**说明**：查询疑似人工调整的资金流水。

**参数**：
| 参数         | 说明                                   |
|--------------|----------------------------------------|
| `page`/`page_size` | 分页                             |
| `start_time`/`end_time` | 时间区间                    |

---

## 17. 错误码（常见 `message`）

| 提示                        | 说明                                 |
|-----------------------------|--------------------------------------|
| `签名错误`                  | `sign` 校验失败                      |
| `timestamp已过期`           | 时间戳超出允许范围                   |
| `商户号不存在或已停用`      | 商户状态异常                         |
| `notify_url 无效`           | 参数校验失败                         |
| `没有对应金额`              | 通道金额限制或未配置                 |
| `系统繁忙，请稍后重试。`    | 系统内部异常                         |

---

## 18. 调试建议

1. 调试时务必更新 `timestamp` 并重新计算签名。
2. 若提示 `签名错误`，请检查参数排序、是否遗漏业务参数、是否使用 master key。
3. `/createorder` 会真实写库，请使用合适回调地址和金额（建议小额测试）。
4. 对接过程中如需 SDK 或进一步支持，请联系技术团队。
